<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Tutorial: Using AWS Lambda with Amazon S3 - AWS Lambda</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="home" href="#top">
      <link rel="up" href="with-s3.html" title="Using AWS Lambda with Amazon S3">
      <link rel="prev" href="with-s3.html" title="Using AWS Lambda with Amazon S3">
      <link rel="next" href="with-s3-example-deployment-pkg.html" title="Sample Amazon Simple Storage Service Function Code">
      <meta name="description" content="Suppose you want to create a thumbnail for each image file that is uploaded to a bucket. You can create a Lambda function ( CreateThumbnail ) that Amazon S3 can invoke when objects are created. Then, the Lambda function can read the image object from the source bucket and create a thumbnail image target bucket.">
      <meta name="keywords" content="Lambda,AWS Lambda,serverless,serverless applications,cloud computing">
      <meta name="deployment_region" content="IAD">
      <meta name="product" content="AWS Lambda">
      <meta name="guide" content="Developer Guide">
      <meta name="guide-locale" content="en_us">
      <meta name="tocs" content="toc-contents.json">
      <meta name="marketingLocale" content="en_US">
      <link rel="icon" type="image/ico" href="/images/favicon.ico">
      <link rel="shortcut icon" type="image/ico" href="/images/favicon.ico">
      <link rel="canonical" href="https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example.html">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="../../../css/google-font.css">
      <link id="code-style" rel="stylesheet" type="text/css" href="../../../css/light.css">
      <link rel="stylesheet" type="text/css" href="../../../css/jquery-ui.theme.css">
      <link rel="stylesheet" type="text/css" href="../../../css/colorbox.css">
      <link rel="stylesheet" type="text/css" href="../../../css/awsdocs.css"><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript" src="/js/jquery.min.js"></script><script type="text/javascript" src="/js/jquery-ui.min.js"></script><script type="text/javascript" src="/js/jquery.colorbox.js"></script><script type="text/javascript" src="/js/awsdocs.min.js?v=20181221"></script><link rel="stylesheet" type="text/css" href="../../../css/marketing-target.css"><script type="text/javascript" src="/assets/marketing/js/marketing-target.js"></script></head>
   <body id="top">
      
      <div id="content-container">
         
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tbody><tr>
                           <td>
                              <div class="breadcrumb"><a href="/index.html">AWS Documentation</a> &#xBB; <a href="/lambda/index.html">AWS Lambda</a> &#xBB; <a href="index.html">Developer Guide</a> &#xBB; <a href="lambda-services.html">Using AWS Lambda with Other Services</a> &#xBB; <a href="with-s3.html">Using AWS Lambda with Amazon S3</a> &#xBB; <span class="breadcrumb">Tutorial: Using AWS Lambda with Amazon S3</span></div>
                           </td>
                        </tr>
                     </tbody></table>
                     <div id="language-notice">
                        <div class="language-notice-text"></div>
                     </div>
                     <div></div>
                     <h1 class="topictitle" id="with-s3-example">Tutorial: Using AWS Lambda with Amazon S3</h1>
                     <p>Suppose you want to create a thumbnail for each image file that is uploaded to a bucket.
                        You can create a Lambda
                        function (<code class="code">CreateThumbnail</code>) that Amazon S3 can invoke when objects are created. Then, the Lambda function can
                        read the image object from the source bucket and create a thumbnail image target bucket.
                     </p>
                     <p>Upon completing this tutorial, you will have the following Amazon S3, Lambda, and
                        IAM resources in your account: 
                     </p>
                     <div class="mediaobject">
                        
                        <img src="../../..//img/s3-admin-iser-walkthrough-10.png">
                        
                        
                     </div>
                     <div class="itemizedlist">
                        
                        <p class="title"><b>Lambda Resources</b></p>
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>A Lambda function.</p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>An access policy associated with your Lambda function that grants Amazon S3 permission
                                 to invoke the Lambda
                                 function.
                              </p>
                              
                           </li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        
                        <p class="title"><b>IAM Resources</b></p>
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>An execution role that grants permissions that your Lambda function needs through
                                 the permissions policy
                                 associated with this role.
                              </p>
                              
                           </li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        
                        <p class="title"><b>Amazon S3 Resources</b></p>
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>A source bucket with a notification configuration that invokes the Lambda function.</p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>A target bucket where the function saves resized images.</p>
                              
                           </li>
                        </ul>
                     </div>
                     
                     <h2 id="with-s3-prepare">Prerequisites</h2>
                      
                     <p>This tutorial assumes that you have some knowledge of basic Lambda operations and
                        the Lambda console. If you
                        haven&apos;t already, follow the instructions in <a href="getting-started.html">Getting Started with AWS Lambda</a> to create your first Lambda function.
                     </p>
                      
                     <p>To follow the procedures in this guide, you will need a command line terminal or shell
                        to run commands. Commands are shown in
                        listings preceded by a
                        prompt symbol ($) and the name of the current directory, when appropriate:
                     </p>
                     <pre class="programlisting"><div class="code-btn-container"><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">~/lambda-project$ <strong class="userinput"><code>this is a command</code></strong>
this is output</code></pre>
                     <p>For long commands, an escape character (<code class="code">\</code>) is used to split a command over multiple lines.
                     </p>
                     
                     <p>On Linux and macOS, use your preferred shell and package manager. On Windows 10, you
                        can <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10" target="_blank">install the Windows Subsystem for Linux</a> to get a Windows-integrated version of 
                        Ubuntu and Bash.
                     </p>
                     
                     
                     <p>Install NPM to manage the function&apos;s dependencies.</p>
                     
                     
                     
                     <h2 id="with-s3-create-execution-role">Create the Execution Role</h2>
                     
                     <p>Create the <a href="lambda-intro-execution-role.html">execution role</a> that gives your function
                        permission to access AWS resources.
                     </p>
                     
                     <p class="title"><b>To create an execution role</b></p>
                     <ol>
                        <li>
                           
                           <p>Open the <a href="https://console.aws.amazon.com/iam/home#/roles" target="_blank">roles page</a> in the IAM console.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Create role</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Create a role with the following properties.</p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p><b>Trusted entity</b> &#x2013; <b>AWS Lambda</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p><b>Permissions</b> &#x2013; <b>AWSLambdaExecute</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p><b>Role name</b> &#x2013; <strong class="userinput"><code>lambda-s3-role</code></strong>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                        </li>
                     </ol>
                     
                     <p>The <b>AWSLambdaExecute</b> policy has the permissions that the function needs to manage objects
                        in Amazon S3 and write logs to CloudWatch Logs.
                     </p>
                     
                     
                     <h2 id="with-s3-example-prepare-create-buckets">Create Buckets and Upload a Sample Object</h2>
                     
                     <p>Follow the steps to create buckets and upload an object.</p>
                     
                     <div class="orderedlist">
                        
                        
                        
                        
                        <ol>
                           <li>
                              
                              <p>Open the <a href="https://console.aws.amazon.com/s3" target="_blank">Amazon S3 console</a>.
                              </p>
                              
                           </li>
                           <li>
                              
                              <p>Create two buckets. The target bucket name must be <em class="replaceable"><code>source</code></em> followed by
                                 <strong class="userinput"><code>resized</code></strong>, where <em class="replaceable"><code>source</code></em> is the name of the bucket you want
                                 to use for the source. For example, <code class="code">mybucket</code> and <code class="code">mybucketresized</code>.
                              </p>
                              
                           </li>
                           <li>
                              
                              <p>In the source bucket, upload a .jpg object, <code>HappyFace.jpg</code>. 
                              </p>
                              
                              <p>When you invoke the Lambda function manually before you connect to Amazon S3, you
                                 pass sample event data to the
                                 function that specifies the source bucket and <code>HappyFace.jpg</code> as the newly created object
                                 so you need to create this sample object first.
                              </p>
                              
                           </li>
                        </ol>
                     </div>
                     
                     
                     <h2 id="with-s3-example-create-function">Create the Function</h2>
                     
                     
                     <p>The following example code receives an Amazon S3 event input and processes the message
                        that it contains. It resizes
                        an image in the source bucket and saves the output to the target bucket.
                     </p>
                     
                     
                     <div class="aws-note">
                        <p class="aws-note">Note</p>
                        <p>For sample code in other languages, see <a href="with-s3-example-deployment-pkg.html">Sample Amazon Simple Storage Service Function Code</a>.
                        </p>
                     </div>
                     
                     <div class="example">
                        <p class="title"><b>Example index.js</b></p>
                        <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">// dependencies
var async = require(&apos;async&apos;);
var AWS = require(&apos;aws-sdk&apos;);
var gm = require(&apos;gm&apos;)
            .subClass({ imageMagick: true }); // Enable ImageMagick integration.
var util = require(&apos;util&apos;);

// constants
var MAX_WIDTH  = 100;
var MAX_HEIGHT = 100;

// get reference to S3 client 
var s3 = new AWS.S3();
 
exports.handler = function(event, context, callback) {
    // Read options from the event.
    console.log(&quot;Reading options from event:\n&quot;, util.inspect(event, {depth: 5}));
    var srcBucket = event.Records[0].s3.bucket.name;
    // Object key may have spaces or unicode non-ASCII characters.
    var srcKey    =
    decodeURIComponent(event.Records[0].s3.object.key.replace(/\+/g, &quot; &quot;));  
    var dstBucket = srcBucket + &quot;resized&quot;;
    var dstKey    = &quot;resized-&quot; + srcKey;

    // Sanity check: validate that source and destination are different buckets.
    if (srcBucket == dstBucket) {
        callback(&quot;Source and destination buckets are the same.&quot;);
        return;
    }

    // Infer the image type.
    var typeMatch = srcKey.match(/\.([^.]*)$/);
    if (!typeMatch) {
        callback(&quot;Could not determine the image type.&quot;);
        return;
    }
    var imageType = typeMatch[1];
    if (imageType != &quot;jpg&quot; &amp;&amp; imageType != &quot;png&quot;) {
        callback(&apos;Unsupported image type: ${imageType}&apos;);
        return;
    }

    // Download the image from S3, transform, and upload to a different S3 bucket.
    async.waterfall([
        function download(next) {
            // Download the image from S3 into a buffer.
            s3.getObject({
                    Bucket: srcBucket,
                    Key: srcKey
                },
                next);
            },
        function transform(response, next) {
            gm(response.Body).size(function(err, size) {
                // Infer the scaling factor to avoid stretching the image unnaturally.
                var scalingFactor = Math.min(
                    MAX_WIDTH / size.width,
                    MAX_HEIGHT / size.height
                );
                var width  = scalingFactor * size.width;
                var height = scalingFactor * size.height;

                // Transform the image buffer in memory.
                this.resize(width, height)
                    .toBuffer(imageType, function(err, buffer) {
                        if (err) {
                            next(err);
                        } else {
                            next(null, response.ContentType, buffer);
                        }
                    });
            });
        },
        function upload(contentType, data, next) {
            // Stream the transformed image to a different S3 bucket.
            s3.putObject({
                    Bucket: dstBucket,
                    Key: dstKey,
                    Body: data,
                    ContentType: contentType
                },
                next);
            }
        ], function (err) {
            if (err) {
                console.error(
                    &apos;Unable to resize &apos; + srcBucket + &apos;/&apos; + srcKey +
                    &apos; and upload to &apos; + dstBucket + &apos;/&apos; + dstKey +
                    &apos; due to an error: &apos; + err
                );
            } else {
                console.log(
                    &apos;Successfully resized &apos; + srcBucket + &apos;/&apos; + srcKey +
                    &apos; and uploaded to &apos; + dstBucket + &apos;/&apos; + dstKey
                );
            }

            callback(null, &quot;message&quot;);
        }
    );
};
</code></pre></div>
                     </div>
                     
                     <p>Review the preceding code and note the following:</p>
                     
                     <div class="itemizedlist">
                        
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>The function knows the source bucket name and the key name of the object from the
                                 event data it receives
                                 as parameters. If the object is a .jpg, the code creates a thumbnail and saves it
                                 to the target bucket.
                                 
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>The code assumes that the destination bucket exists and its name is a concatenation
                                 of the source bucket
                                 name followed by the string <code class="code">resized</code>. For example, if the source bucket identified in the event
                                 data is <code class="code">examplebucket</code>, the code assumes you have an <code class="code">examplebucketresized</code> destination
                                 bucket.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>For the thumbnail it creates, the code derives its key name as the concatenation of
                                 the string
                                 <code class="code">resized-</code> followed by the source object key name. For example, if the source object key is
                                 <code class="code">sample.jpg</code>, the code creates a thumbnail object that has the key
                                 <code class="code">resized-sample.jpg</code>.
                              </p>
                              
                           </li>
                        </ul>
                     </div>
                     
                     <p>The deployment package is a .zip file containing your Lambda function code and dependencies.
                        
                     </p>
                     
                     <p class="title"><b>To create a deployment package</b></p>
                     <ol>
                        <li>
                           
                           <p>Save the function code as <code>index.js</code> in a folder named
                              <code>lambda-s3</code>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Install the GraphicsMagick and Async libraries with NPM.</p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">lambda-s3$ <strong class="userinput"><code>npm install async gm</code></strong></code></pre>
                           <p>After you complete this step, you will have the following folder structure:</p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight ">lambda-s3
|- index.js
|- /node_modules/gm
&#x2514; /node_modules/async</code></pre>
                           </li>
                        <li>
                           
                           <p>Create a deployment package with the function code and dependencies.</p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">lambda-s3$ <strong class="userinput"><code>zip -r function.zip .</code></strong></code></pre>
                           </li>
                     </ol>
                     
                     
                     <p class="title"><b>To create the function</b></p>
                     <ul>
                        <li>
                           
                           <p>Create a Lambda function with the <code class="code">create-function</code> command.
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">$ <strong class="userinput"><code>aws lambda create-function --function-name CreateThumbnail \
--zip-file fileb://function.zip --handler index.handler --runtime nodejs8.10 \
--timeout 10 --memory-size 1024 \
--role arn:aws:iam::<em class="replaceable"><code>123456789012</code></em>:role/lambda-s3-role</code></strong></code></pre>
                           </li>
                     </ul>
                     
                     <p>The preceding command specifies a 10-second timeout value as the function configuration.
                        Depending on the size
                        of objects you upload, you might need to increase the timeout value using the following
                        AWS CLI command.
                     </p>
                     <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">$ <strong class="userinput"><code>aws lambda update-function-configuration --function-name CreateThumbnail --timeout <em class="replaceable"><code>30</code></em></code></strong></code></pre>
                     
                     <h2 id="walkthrough-s3-events-adminuser-create-test-function-upload-zip-test-manual-invoke">Test the
                        Lambda Function
                     </h2>
                     
                     <p>In this step, you invoke the Lambda function manually using sample Amazon S3 event
                        data.
                     </p>
                     
                     <p class="title"><b>To test the Lambda function</b></p>
                     <ol>
                        <li>
                           
                           <p>Save the following Amazon S3 sample event data in a file and save it as <code>inputFile.txt</code>. You
                              need to update the JSON by providing your <em class="replaceable"><code>sourcebucket</code></em> name and a .jpg object
                              key.
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">{
  &quot;Records&quot;:[  
    {  
      &quot;eventVersion&quot;:&quot;2.0&quot;,
      &quot;eventSource&quot;:&quot;aws:s3&quot;,
      &quot;awsRegion&quot;:&quot;us-west-2&quot;,
      &quot;eventTime&quot;:&quot;1970-01-01T00:00:00.000Z&quot;,
      &quot;eventName&quot;:&quot;ObjectCreated:Put&quot;,
      &quot;userIdentity&quot;:{  
        &quot;principalId&quot;:&quot;AIDAJDPLRKLG7UEXAMPLE&quot;
      },
      &quot;requestParameters&quot;:{  
        &quot;sourceIPAddress&quot;:&quot;127.0.0.1&quot;
      },
      &quot;responseElements&quot;:{  
        &quot;x-amz-request-id&quot;:&quot;C3D13FE58DE4C810&quot;,
        &quot;x-amz-id-2&quot;:&quot;FMyUVURIY8/IgAtTv8xRjskZQpcIZ9KG4V5Wp6S7S/JRWeUWerMUE5JgHvANOjpD&quot;
      },
      &quot;s3&quot;:{  
        &quot;s3SchemaVersion&quot;:&quot;1.0&quot;,
        &quot;configurationId&quot;:&quot;testConfigRule&quot;,
        &quot;bucket&quot;:{  
          &quot;name&quot;:&quot;<em class="replaceable"><code>sourcebucket</code></em>&quot;,
          &quot;ownerIdentity&quot;:{  
            &quot;principalId&quot;:&quot;A3NL1KOZZKExample&quot;
          },
          &quot;arn&quot;:&quot;arn:aws:s3:::<em class="replaceable"><code>sourcebucket</code></em>&quot;
        },
        &quot;object&quot;:{  
          &quot;key&quot;:&quot;<em class="replaceable"><code>HappyFace.jpg</code></em>&quot;,
          &quot;size&quot;:1024,
          &quot;eTag&quot;:&quot;d41d8cd98f00b204e9800998ecf8427e&quot;,
          &quot;versionId&quot;:&quot;096fKKXTRTtl3on89fVO.nfljtsv6qko&quot;
        }
      }
    }
  ]
}</code></pre>
                           </li>
                        <li>
                           
                           <p>Run the following Lambda CLI <code class="code">invoke</code> command to invoke the function. Note that the command
                              requests asynchronous execution. You can optionally invoke it synchronously by specifying
                              <code class="code">RequestResponse</code> as the <code class="code">invocation-type</code> parameter value.
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">$ <strong class="userinput"><code>aws lambda invoke --function-name CreateThumbnail --invocation-type Event \
--payload file://inputfile.txt outputfile.txt</code></strong></code></pre>
                           </li>
                        <li>
                           
                           <p>Verify that the thumbnail was created in the target bucket.</p>
                           
                        </li>
                     </ol>
                     
                     
                     <h2 id="with-s3-example-configure-event-source">Configure Amazon S3 to Publish Events</h2>
                     
                     <p>In this step, you add the remaining configuration so that Amazon S3 can publish object-created
                        events to AWS Lambda
                        and invoke your Lambda function. You do the following in this step:
                     </p>
                     
                     <div class="itemizedlist">
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>Add permissions to the Lambda function access policy to allow Amazon S3 to invoke
                                 the function.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>Add notification configuration to your source bucket. In the notification configuration,
                                 you provide the
                                 following:
                              </p>
                              
                              <div class="itemizedlist">
                                 
                                 
                                 
                                 <ul class="itemizedlist" type="disc">
                                    <li class="listitem">
                                       
                                       <p>Event type for which you want Amazon S3 to publish events. For this tutorial, you
                                          specify the
                                          <code class="code">s3:ObjectCreated:*</code> event type so that Amazon S3 publishes events when objects are
                                          created.
                                       </p>
                                       
                                    </li>
                                    <li class="listitem">
                                       
                                       <p>Lambda function to invoke.</p>
                                       
                                    </li>
                                 </ul>
                              </div>
                              
                           </li>
                        </ul>
                     </div>
                     
                     <p class="title"><b>To add permissions to the function policy</b></p>
                     <ol>
                        <li>
                           
                           <p>Run the following Lambda CLI <code class="code">add-permission</code> command to grant Amazon S3 service principal
                              (<code class="code">s3.amazonaws.com</code>) permissions to perform the <code class="code">lambda:InvokeFunction</code> action. Note
                              that permission is granted to Amazon S3 to invoke the function only if the following
                              conditions are met:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>An object-created event is detected on a specific bucket.</p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>The bucket is owned by a specific AWS account. If a bucket owner deletes a bucket,
                                       some other AWS
                                       account can create a bucket with the same name. This condition ensures that only a
                                       specific AWS account
                                       can invoke your Lambda function.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">$ <strong class="userinput"><code>aws lambda add-permission --function-name CreateThumbnail --principal s3.amazonaws.com \
--statement-id <em class="replaceable"><code>some-unique-id</code></em> --action &quot;lambda:InvokeFunction&quot; \
--source-arn arn:aws:s3:::<em class="replaceable"><code>sourcebucket</code></em> \
--source-account <em class="replaceable"><code>bucket-owner-account-id</code></em></code></strong></code></pre>
                           </li>
                        <li>
                           
                           <p>Verify the function&apos;s access policy by running the AWS CLI <code class="code">get-policy</code> command.
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="nohighlight">$ <strong class="userinput"><code>aws lambda get-policy --function-name <em class="replaceable"><code>function-name</code></em></code></strong></code></pre>
                           </li>
                     </ol>
                     
                     <p>Add notification configuration on the source bucket to request Amazon S3 to publish
                        object-created events to
                        Lambda.
                     </p>
                     
                     <p class="title"><b>To configure notifications</b></p>
                     <ol>
                        <li>
                           
                           <p>Open the <a href="https://console.aws.amazon.com/s3" target="_blank">Amazon S3 console</a>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Choose the source bucket.</p>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Properties</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Events</b>, configure a notification with the following settings.
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p><b>Name</b> &#x2013; <strong class="userinput"><code>lambda-trigger</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p><b>Events</b> &#x2013; <strong class="userinput"><code>ObjectCreate (All)</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p><b>Send to</b> &#x2013; <strong class="userinput"><code>Lambda function</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p><b>Lambda</b> &#x2013; <strong class="userinput"><code>CreateThumbnail</code></strong>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                        </li>
                     </ol>
                     
                     <p>For more information on event configuration, see <a href="./AmazonS3/latest/user-guide/enable-event-notifications.html">Enabling Event Notifications</a> in the <em>Amazon Simple Storage Service Console User Guide</em>.
                     </p>
                     
                     
                     <h2 id="with-s3-example-configure-event-source-test-end-to-end">Test the Setup</h2>
                     
                     <p>Now you can test the setup as follows:</p>
                     
                     <div class="orderedlist">
                        
                        
                        
                        
                        <ol>
                           <li>
                              
                              <p>Upload .jpg or .png objects to the source bucket using the Amazon S3 console.</p>
                              
                           </li>
                           <li>
                              
                              <p>Verify that the thumbnail was created in the target bucket using the <code class="code">CreateThumbnail</code>
                                 function.
                              </p>
                              
                           </li>
                           <li>
                              
                              <p>View logs in the CloudWatch console. </p>
                              
                           </li>
                        </ol>
                     </div>
                     
                     <div id="marketing-target"><span class="close-button"></span><div class="marketing-title" id="marketing-title"></div>
                        <div class="marketing-description"><span id="marketing-description"></span><span id="marketing-cta"></span></div>
                     </div>
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                       browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be
                                    enabled. Please refer to your browser's Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="with-s3.html">&#xAB; Previous </a><a class="awstoc" accesskey="n" href="with-s3-example-deployment-pkg.html">Next &#xBB;</a></div>
                     <div id="copyright-main-footer">&#xA9; 2019, Amazon Web Services, Inc. or its affiliates. All rights
                        reserved.
                     </div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Prerequisites"><a class="pagetoc" href="#with-s3-prepare">Prerequisites</a></li>
                        <li class="pagetoc" name="Create the Execution Role"><a class="pagetoc" href="#with-s3-create-execution-role">Create the Execution Role</a></li>
                        <li class="pagetoc" name="Create Buckets and Upload a Sample Object"><a class="pagetoc" href="#with-s3-example-prepare-create-buckets">Create Buckets and Upload a Sample Object</a></li>
                        <li class="pagetoc" name="Create the Function"><a class="pagetoc" href="#with-s3-example-create-function">Create the Function</a></li>
                        <li class="pagetoc" name="Test the
        Lambda Function"><a class="pagetoc" href="#walkthrough-s3-events-adminuser-create-test-function-upload-zip-test-manual-invoke">Test the
                              Lambda Function</a></li>
                        <li class="pagetoc" name="Configure Amazon S3 to Publish Events"><a class="pagetoc" href="#with-s3-example-configure-event-source">Configure Amazon S3 to Publish Events</a></li>
                        <li class="pagetoc" name="Test the Setup"><a class="pagetoc" href="#with-s3-example-configure-event-source-test-end-to-end">Test the Setup</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div id="cookie-notice">
         <div class="cookie-notice-text">We use cookies to provide and improve our services. By using
            our site, you consent to cookies. <a href="http://aws.amazon.com/legal/cookies">Learn more</a></div>
      </div>
      
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='AWS Lambda';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='Developer Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   
</body></html>